name: Build Image to Docker Hub 

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: "Version bump type ('none' for 'latest' only)"
        required: true
        type: choice
        options:
          - none
          - patch
          - minor
          - major
        default: "patch"
      push_on_test_failure:
        description: "Push image even if tests fail?"
        required: true
        type: choice
        options:
          - "no"
          - "yes"
        default: "yes"
      image_name:
        description: "Image name"
        required: true
        type: string
        default: "api"

jobs:
  # ============================================
  # PRE-BUILD TESTS
  # ============================================
  
  lint:
    name: Lint
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install
      
      - name: Run ESLint
        run: |
          if npm run lint 2>/dev/null; then
            echo "✅ Lint passed"
          else
            echo "⚠️ Lint script not configured - skipping"
          fi

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install
      
      - name: Run Unit Tests
        run: |
          if npm test 2>/dev/null; then
            echo "✅ Tests passed"
          else
            echo "⚠️ Test script not configured - skipping"
          fi

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install
      
      - name: Run Integration Tests
        run: |
          if npm run test:integration 2>/dev/null; then
            echo "✅ Integration tests passed"
          else
            echo "⚠️ Integration test script not configured - skipping"
          fi

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install
      
      - name: Run npm audit
        run: npm audit --audit-level=moderate || true

  dockerfile-lint:
    name: Dockerfile Lint
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning

  # NEW: Dependency validation
  dependency-check:
    name: Dependency Validation
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Validate package.json
        run: |
          echo "=== Validating package.json ==="
          if [ -f "package.json" ]; then
            if jq empty package.json 2>/dev/null; then
              echo "✅ package.json is valid JSON"
            else
              echo "❌ package.json is invalid JSON"
              exit 1
            fi
          else
            echo "❌ package.json not found"
            exit 1
          fi
      
      - name: Check for outdated dependencies
        run: |
          echo "=== Checking for outdated dependencies ==="
          npm install
          npm outdated || echo "⚠️ Some dependencies are outdated"
      
      - name: Check for duplicate dependencies
        run: |
          echo "=== Checking for duplicate dependencies ==="
          npm dedupe --dry-run || echo "⚠️ Duplicate dependencies found"

  # NEW: License compliance check
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install
      
      - name: Install license-checker
        run: npm install -g license-checker
      
      - name: Check licenses (Summary)
        run: |
          echo "=== License Summary ==="
          license-checker --summary
      
      - name: Check licenses (Detailed)
        run: |
          echo "=== Detailed License Report ==="
          license-checker --json > licenses.json
          cat licenses.json
      
      - name: Check for prohibited licenses
        run: |
          echo "=== Checking for Prohibited Licenses ==="
          
          # Define prohibited licenses (GPL variants that may cause issues)
          PROHIBITED="GPL|AGPL|LGPL"
          
          if license-checker --json | jq -r '.[] | .licenses' | grep -iE "$PROHIBITED"; then
            echo "⚠️ WARNING: Found potentially problematic licenses (GPL family)"
            echo "Review these licenses for compatibility with your project"
            license-checker --json | jq -r 'to_entries[] | select(.value.licenses | test("GPL|AGPL|LGPL"; "i")) | "\(.key): \(.value.licenses)"'
          else
            echo "✅ No prohibited licenses found"
          fi
      
      - name: Generate license report
        run: |
          echo "=== Generating License Report ==="
          license-checker --csv > license-report.csv
          echo "✅ License report generated"
      
      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: |
            licenses.json
            license-report.csv
          retention-days: 30

  # ============================================
  # BUILD IMAGE
  # ============================================
  
  build-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests, security, dockerfile-lint, dependency-check, license-check]
    if: ${{ always() }}
    environment: dev
    permissions:
      contents: write
      packages: write
    outputs:
      image_tag: ${{ steps.version.outputs.tag }}
      image_name: ${{ steps.version.outputs.full_image_name }}
      local_image_name: ${{ inputs.image_name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest version from Docker Hub
        id: get-version
        if: inputs.version_bump != 'none'
        run: |
          FULL_IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/${{ inputs.image_name }}"
          TAGS=$(curl -s "https://hub.docker.com/v2/repositories/$FULL_IMAGE_NAME/tags/?page_size=100" | jq -r '.results[].name' | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sed 's/^v//' | sort -V | tail -1)
          
          if [ -z "$TAGS" ]; then
            LATEST_VERSION="0.0.0"
          else
            LATEST_VERSION="$TAGS"
          fi
          
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: Bump version
        id: bump
        if: inputs.version_bump != 'none'
        run: |
          LATEST_VERSION="${{ steps.get-version.outputs.latest_version }}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST_VERSION"
          
          case "${{ inputs.version_bump }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Set version tag and full image name
        id: version
        run: |
          FULL_IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/${{ inputs.image_name }}"
          echo "full_image_name=$FULL_IMAGE_NAME" >> $GITHUB_OUTPUT
          
          if [ "${{ inputs.version_bump }}" = "none" ]; then
            VERSION_TAG="latest"
          else
            VERSION_TAG="${{ steps.bump.outputs.new_version }}"
          fi
          echo "tag=$VERSION_TAG" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check Test Results
        run: |
          echo "=== Test Results Summary ==="
          echo "Lint: ${{ needs.lint.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Dockerfile Lint: ${{ needs.dockerfile-lint.result }}"
          echo "Dependency Check: ${{ needs.dependency-check.result }}"
          echo "License Check: ${{ needs.license-check.result }}"
          echo "Push on failure: ${{ inputs.push_on_test_failure }}"
          
          if [ "${{ inputs.push_on_test_failure }}" = "yes" ]; then
            echo "⚠️ Building image despite test failures (push_on_test_failure=yes)"
          else
            echo "✅ All tests passed, proceeding with build"
          fi

      - name: Build Docker Image
        run: |
          VERSION_TAG="${{ steps.version.outputs.tag }}"
          LOCAL_IMAGE_NAME="${{ inputs.image_name }}"
          
          echo "=== Building Docker Image ==="
          docker build -t $LOCAL_IMAGE_NAME:$VERSION_TAG .
          echo "✅ Docker image built: $LOCAL_IMAGE_NAME:$VERSION_TAG"

      - name: Save Docker Image
        run: |
          VERSION_TAG="${{ steps.version.outputs.tag }}"
          LOCAL_IMAGE_NAME="${{ inputs.image_name }}"
          
          echo "=== Saving Docker Image ==="
          docker save $LOCAL_IMAGE_NAME:$VERSION_TAG | gzip > /tmp/docker-image.tar.gz
          echo "✅ Image saved"

      - name: Upload Docker Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/docker-image.tar.gz
          retention-days: 1

  # ============================================
  # POST-BUILD TESTS
  # ============================================

  # NEW: Vulnerability scan with Trivy
  test-image-vulnerabilities:
    name: Scan Image Vulnerabilities
    runs-on: ubuntu-latest
    needs: [build-image]
    if: ${{ always() && needs.build-image.result == 'success' }}
    continue-on-error: ${{ inputs.push_on_test_failure == 'yes' }}
    
    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker Image
        run: |
          echo "=== Loading Docker Image ==="
          docker load < /tmp/docker-image.tar.gz
          echo "✅ Image loaded"

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ needs.build-image.outputs.local_image_name }}:${{ needs.build-image.outputs.image_tag }}'
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  test-image-health:
    name: Test Image Health
    runs-on: ubuntu-latest
    needs: [build-image]
    if: ${{ always() && needs.build-image.result == 'success' }}
    continue-on-error: ${{ inputs.push_on_test_failure == 'yes' }}
    
    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker Image
        run: |
          echo "=== Loading Docker Image ==="
          docker load < /tmp/docker-image.tar.gz
          echo "✅ Image loaded"

      - name: Test Health Endpoint
        run: |
          IMAGE_URI="${{ needs.build-image.outputs.local_image_name }}:${{ needs.build-image.outputs.image_tag }}"
          
          echo "=== Testing Health Endpoint ==="
          docker run -d --name health-test \
            -p 3000:3000 \
            -e DBUSER=testuser \
            -e DB=testdb \
            -e DBPASS=testpass \
            -e DBHOST=localhost \
            -e DBPORT=3306 \
            $IMAGE_URI
          
          sleep 5
          
          echo "Testing /health endpoint..."
          if curl -f http://localhost:3000/health; then
            echo "✅ Health check passed"
          else
            echo "❌ Health check failed"
            docker logs health-test
            exit 1
          fi
          
          docker stop health-test
          docker rm health-test

  test-image-startup:
    name: Test Image Startup
    runs-on: ubuntu-latest
    needs: [build-image]
    if: ${{ always() && needs.build-image.result == 'success' }}
    continue-on-error: ${{ inputs.push_on_test_failure == 'yes' }}
    
    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker Image
        run: |
          echo "=== Loading Docker Image ==="
          docker load < /tmp/docker-image.tar.gz
          echo "✅ Image loaded"

      - name: Test Container Startup
        run: |
          IMAGE_URI="${{ needs.build-image.outputs.local_image_name }}:${{ needs.build-image.outputs.image_tag }}"
          
          echo "=== Testing Container Startup ==="
          docker run -d --name startup-test \
            -p 3001:3000 \
            -e DBUSER=testuser \
            -e DB=testdb \
            -e DBPASS=testpass \
            -e DBHOST=localhost \
            -e DBPORT=3306 \
            $IMAGE_URI
          
          sleep 5
          
          if docker ps | grep startup-test; then
            echo "✅ Container started successfully"
          else
            echo "❌ Container failed to start"
            docker logs startup-test
            exit 1
          fi
          
          docker stop startup-test
          docker rm startup-test

  test-image-size:
    name: Test Image Size
    runs-on: ubuntu-latest
    needs: [build-image]
    if: ${{ always() && needs.build-image.result == 'success' }}
    continue-on-error: ${{ inputs.push_on_test_failure == 'yes' }}
    
    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker Image
        run: |
          echo "=== Loading Docker Image ==="
          docker load < /tmp/docker-image.tar.gz
          echo "✅ Image loaded"

      - name: Check Image Size
        run: |
          IMAGE_URI="${{ needs.build-image.outputs.local_image_name }}:${{ needs.build-image.outputs.image_tag }}"
          
          echo "=== Checking Image Size ==="
          IMAGE_SIZE=$(docker image inspect $IMAGE_URI --format='{{.Size}}')
          IMAGE_SIZE_MB=$((IMAGE_SIZE / 1024 / 1024))
          
          echo "Image size: ${IMAGE_SIZE_MB}MB"
          
          if [ $IMAGE_SIZE_MB -gt 500 ]; then
            echo "⚠️ Image is larger than 500MB"
          else
            echo "✅ Image size is acceptable"
          fi

  # NEW: Port exposure test
  test-image-ports:
    name: Test Port Exposure
    runs-on: ubuntu-latest
    needs: [build-image]
    if: ${{ always() && needs.build-image.result == 'success' }}
    continue-on-error: ${{ inputs.push_on_test_failure == 'yes' }}
    
    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker Image
        run: |
          echo "=== Loading Docker Image ==="
          docker load < /tmp/docker-image.tar.gz
          echo "✅ Image loaded"

      - name: Check Exposed Ports
        run: |
          IMAGE_URI="${{ needs.build-image.outputs.local_image_name }}:${{ needs.build-image.outputs.image_tag }}"
          
          echo "=== Checking Exposed Ports ==="
          EXPOSED_PORTS=$(docker image inspect $IMAGE_URI --format='{{json .Config.ExposedPorts}}')
          echo "Exposed ports: $EXPOSED_PORTS"
          
          if echo "$EXPOSED_PORTS" | grep -q "3000"; then
            echo "✅ Port 3000 is exposed"
          else
            echo "❌ Port 3000 is not exposed"
            exit 1
          fi

  # NEW: Environment variables test
  test-image-env-vars:
    name: Test Environment Variables
    runs-on: ubuntu-latest
    needs: [build-image]
    if: ${{ always() && needs.build-image.result == 'success' }}
    continue-on-error: ${{ inputs.push_on_test_failure == 'yes' }}
    
    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker Image
        run: |
          echo "=== Loading Docker Image ==="
          docker load < /tmp/docker-image.tar.gz
          echo "✅ Image loaded"

      - name: Test with Missing Environment Variables
        run: |
          IMAGE_URI="${{ needs.build-image.outputs.local_image_name }}:${{ needs.build-image.outputs.image_tag }}"
          
          echo "=== Testing with Missing Env Vars ==="
          docker run -d --name env-test -p 3002:3000 $IMAGE_URI || true
          
          sleep 3
          
          # Check if container is still running or exited gracefully
          if docker ps -a | grep env-test | grep -q "Exited"; then
            echo "⚠️ Container exited (expected if env vars are required)"
            docker logs env-test
          else
            echo "✅ Container handles missing env vars gracefully"
          fi
          
          docker stop env-test 2>/dev/null || true
          docker rm env-test 2>/dev/null || true

  # NEW: User permissions test
  test-image-security:
    name: Test Security (Non-root User)
    runs-on: ubuntu-latest
    needs: [build-image]
    if: ${{ always() && needs.build-image.result == 'success' }}
    continue-on-error: ${{ inputs.push_on_test_failure == 'yes' }}
    
    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker Image
        run: |
          echo "=== Loading Docker Image ==="
          docker load < /tmp/docker-image.tar.gz
          echo "✅ Image loaded"

      - name: Check User Permissions
        run: |
          IMAGE_URI="${{ needs.build-image.outputs.local_image_name }}:${{ needs.build-image.outputs.image_tag }}"
          
          echo "=== Checking User Permissions ==="
          USER=$(docker image inspect $IMAGE_URI --format='{{.Config.User}}')
          
          if [ -z "$USER" ] || [ "$USER" = "root" ] || [ "$USER" = "0" ]; then
            echo "⚠️ Container runs as root user (security risk)"
          else
            echo "✅ Container runs as non-root user: $USER"
          fi

  # NEW: Graceful shutdown test
  test-image-shutdown:
    name: Test Graceful Shutdown
    runs-on: ubuntu-latest
    needs: [build-image]
    if: ${{ always() && needs.build-image.result == 'success' }}
    continue-on-error: ${{ inputs.push_on_test_failure == 'yes' }}
    
    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker Image
        run: |
          echo "=== Loading Docker Image ==="
          docker load < /tmp/docker-image.tar.gz
          echo "✅ Image loaded"

      - name: Test SIGTERM Handling
        run: |
          IMAGE_URI="${{ needs.build-image.outputs.local_image_name }}:${{ needs.build-image.outputs.image_tag }}"
          
          echo "=== Testing Graceful Shutdown ==="
          docker run -d --name shutdown-test \
            -p 3003:3000 \
            -e DBUSER=testuser \
            -e DB=testdb \
            -e DBPASS=testpass \
            -e DBHOST=localhost \
            -e DBPORT=3306 \
            $IMAGE_URI
          
          sleep 3
          
          echo "Sending SIGTERM..."
          START_TIME=$(date +%s)
          docker stop -t 10 shutdown-test
          END_TIME=$(date +%s)
          SHUTDOWN_TIME=$((END_TIME - START_TIME))
          
          echo "Shutdown time: ${SHUTDOWN_TIME}s"
          
          if [ $SHUTDOWN_TIME -lt 10 ]; then
            echo "✅ Container shut down gracefully in ${SHUTDOWN_TIME}s"
          else
            echo "⚠️ Container took full timeout (10s) to shutdown"
          fi
          
          docker rm shutdown-test

  # NEW: Layer analysis
  test-image-layers:
    name: Analyze Image Layers
    runs-on: ubuntu-latest
    needs: [build-image]
    if: ${{ always() && needs.build-image.result == 'success' }}
    continue-on-error: true
    
    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker Image
        run: |
          echo "=== Loading Docker Image ==="
          docker load < /tmp/docker-image.tar.gz
          echo "✅ Image loaded"

      - name: Analyze Image Layers
        run: |
          IMAGE_URI="${{ needs.build-image.outputs.local_image_name }}:${{ needs.build-image.outputs.image_tag }}"
          
          echo "=== Analyzing Image Layers ==="
          docker history $IMAGE_URI
          
          LAYER_COUNT=$(docker history $IMAGE_URI --format "{{.ID}}" | wc -l)
          echo "Total layers: $LAYER_COUNT"
          
          if [ $LAYER_COUNT -gt 20 ]; then
            echo "⚠️ Image has many layers ($LAYER_COUNT), consider optimization"
          else
            echo "✅ Layer count is reasonable"
          fi

  # ============================================
  # ============================================
  # PUSH IMAGE
  # ============================================

  push-image:
    name: Push Docker Image
    runs-on: ubuntu-latest
    needs: [
      build-image, 
      test-image-vulnerabilities,
      test-image-health, 
      test-image-startup, 
      test-image-size,
      test-image-ports,
      test-image-env-vars,
      test-image-security,
      test-image-shutdown,
      test-image-layers
    ]
    if: ${{ always() && needs.build-image.result == 'success' && (inputs.push_on_test_failure == 'yes' || (needs.test-image-health.result == 'success' && needs.test-image-startup.result == 'success' && needs.test-image-size.result == 'success')) }}
    environment: dev
    
    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker Image
        run: |
          echo "=== Loading Docker Image ==="
          docker load < /tmp/docker-image.tar.gz
          echo "✅ Image loaded"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Tag Images for Docker Hub
        run: |
          VERSION_TAG="${{ needs.build-image.outputs.image_tag }}"
          LOCAL_IMAGE_NAME="${{ needs.build-image.outputs.local_image_name }}"
          FULL_IMAGE_NAME="${{ needs.build-image.outputs.image_name }}"
          
          echo "=== Tagging images for Docker Hub ==="
          echo "Local image: $LOCAL_IMAGE_NAME:$VERSION_TAG"
          echo "Docker Hub image: $FULL_IMAGE_NAME"
          
          # Tag with version
          docker tag $LOCAL_IMAGE_NAME:$VERSION_TAG $FULL_IMAGE_NAME:$VERSION_TAG
          
          # Tag as latest
          docker tag $LOCAL_IMAGE_NAME:$VERSION_TAG $FULL_IMAGE_NAME:latest
          
          echo "✅ Images tagged for Docker Hub"

      - name: Check Image Test Results
        run: |
          echo "=== Image Test Results Summary ==="
          echo "Vulnerabilities: ${{ needs.test-image-vulnerabilities.result }}"
          echo "Health Test: ${{ needs.test-image-health.result }}"
          echo "Startup Test: ${{ needs.test-image-startup.result }}"
          echo "Size Test: ${{ needs.test-image-size.result }}"
          echo "Ports Test: ${{ needs.test-image-ports.result }}"
          echo "Env Vars Test: ${{ needs.test-image-env-vars.result }}"
          echo "Security Test: ${{ needs.test-image-security.result }}"
          echo "Shutdown Test: ${{ needs.test-image-shutdown.result }}"
          echo "Layers Test: ${{ needs.test-image-layers.result }}"
          echo "Push on failure: ${{ inputs.push_on_test_failure }}"
          
          if [ "${{ inputs.push_on_test_failure }}" = "yes" ]; then
            echo "⚠️ Pushing image despite test failures (push_on_test_failure=yes)"
          else
            echo "✅ All image tests passed, proceeding with push"
          fi

      - name: Push Docker Image to Docker Hub
        run: |
          VERSION_TAG="${{ needs.build-image.outputs.image_tag }}"
          FULL_IMAGE_NAME="${{ needs.build-image.outputs.image_name }}"
          
          echo "=== Pushing Docker Image ==="
          
          # Push version tag
          docker push $FULL_IMAGE_NAME:$VERSION_TAG
          echo "✅ Pushed: $FULL_IMAGE_NAME:$VERSION_TAG"
          
          # Always push latest tag
          docker push $FULL_IMAGE_NAME:latest
          echo "✅ Pushed: $FULL_IMAGE_NAME:latest"


  # ============================================
  # CLEANUP ARTIFACTS (After Push)
  # ============================================

  cleanup-artifacts:
    name: Cleanup Temporary Artifacts
    runs-on: ubuntu-latest
    needs: [push-image]
    if: ${{ always() && needs.push-image.result != 'skipped' }}
    
    steps:
      - name: Delete Docker Image Artifact
        uses: geekyeggo/delete-artifact@v5
        with:
          name: docker-image
          failOnError: false
      
      - name: Cleanup Summary
        run: |
          echo "=== Artifact Cleanup ==="
          echo "✅ Docker image artifact deleted from GitHub storage"
          echo "Push Status: ${{ needs.push-image.result }}"
          echo "This frees up storage space and reduces costs"
