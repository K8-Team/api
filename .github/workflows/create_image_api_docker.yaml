name: Build and Push Docker Image to Docker Hub

on:
  workflow_dispatch:
    inputs:
      dockerhub_username:
        description: "Docker Hub username (e.g., liken01else)"
        required: true
        type: string
        default: "liken01else"
      image_name:
        description: "Image name (e.g., api, web, myapp)"
        required: true
        type: string
        default: "api"
      version_bump:
        description: "Version bump type (major, minor, patch) or 'none' for latest only"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - none
        default: "patch"
      push_on_test_failure:
        description: "Push image even if tests fail?"
        required: true
        type: choice
        options:
          - "no"
          - "yes"
        default: "no"

jobs:
  security-scan:
    name: Security & Vulnerability Scan
    runs-on: ubuntu-latest
    continue-on-error: ${{ inputs.push_on_test_failure == 'yes' }}
    defaults:
      run:
        working-directory: NodeJsapp
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: NodeJsapp/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          echo "=== Running npm audit ==="
          npm audit --audit-level=moderate || echo "⚠️ Vulnerabilities found but continuing"

      - name: Run Snyk Security Scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  lint:
    name: Linting
    runs-on: ubuntu-latest
    continue-on-error: ${{ inputs.push_on_test_failure == 'yes' }}
    defaults:
      run:
        working-directory: NodeJsapp
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: NodeJsapp/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Run ESLint
        run: |
          echo "=== Running ESLint ==="
          npx eslint . --ext .js || echo "⚠️ ESLint not configured, skipping"

      - name: Check Code Syntax
        run: |
          echo "=== Checking JavaScript Syntax ==="
          find . -name "*.js" -not -path "./node_modules/*" -exec node -c {} \;
          echo "✅ All JavaScript files have valid syntax"

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    continue-on-error: ${{ inputs.push_on_test_failure == 'yes' }}
    defaults:
      run:
        working-directory: NodeJsapp
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: NodeJsapp/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Run Unit Tests (Mocha)
        run: |
          echo "=== Running Unit Tests ==="
          npm test || echo "⚠️ No tests configured"

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    continue-on-error: ${{ inputs.push_on_test_failure == 'yes' }}
    defaults:
      run:
        working-directory: NodeJsapp
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: NodeJsapp/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Run Integration Tests (Jest/Supertest)
        run: |
          echo "=== Running Integration Tests ==="
          npm run test:integration || echo "⚠️ No integration tests configured"

  type-check:
    name: Type Checking
    runs-on: ubuntu-latest
    continue-on-error: ${{ inputs.push_on_test_failure == 'yes' }}
    defaults:
      run:
        working-directory: NodeJsapp
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: NodeJsapp/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Run TypeScript Type Check
        run: |
          echo "=== Running Type Check ==="
          npx tsc --noEmit || echo "⚠️ TypeScript not configured, skipping"

  dockerfile-lint:
    name: Dockerfile Lint
    runs-on: ubuntu-latest
    continue-on-error: ${{ inputs.push_on_test_failure == 'yes' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: NodeJsapp/Dockerfile
          failure-threshold: warning

  build-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [security-scan, lint, unit-tests, integration-tests, type-check, dockerfile-lint]
    if: ${{ always() && (inputs.push_on_test_failure == 'yes' || (needs.security-scan.result == 'success' && needs.lint.result == 'success' && needs.unit-tests.result == 'success' && needs.integration-tests.result == 'success' && needs.type-check.result == 'success' && needs.dockerfile-lint.result == 'success')) }}
    environment: dev
    permissions:
      contents: write
      packages: write
    outputs:
      image_tag: ${{ steps.version.outputs.tag }}
      image_name: ${{ steps.version.outputs.full_image_name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest version from Docker Hub
        id: get-version
        if: inputs.version_bump != 'none'
        run: |
          FULL_IMAGE_NAME="${{ inputs.dockerhub_username }}/${{ inputs.image_name }}"
          TAGS=$(curl -s "https://hub.docker.com/v2/repositories/$FULL_IMAGE_NAME/tags/?page_size=100" | jq -r '.results[].name' | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sed 's/^v//' | sort -V | tail -1)
          
          if [ -z "$TAGS" ]; then
            LATEST_VERSION="0.0.0"
          else
            LATEST_VERSION="$TAGS"
          fi
          
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: Bump version
        id: bump
        if: inputs.version_bump != 'none'
        run: |
          LATEST_VERSION="${{ steps.get-version.outputs.latest_version }}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST_VERSION"
          
          case "${{ inputs.version_bump }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Set version tag and full image name
        id: version
        run: |
          FULL_IMAGE_NAME="${{ inputs.dockerhub_username }}/${{ inputs.image_name }}"
          echo "full_image_name=$FULL_IMAGE_NAME" >> $GITHUB_OUTPUT
          
          if [ "${{ inputs.version_bump }}" = "none" ]; then
            VERSION_TAG="latest"
          else
            VERSION_TAG="${{ steps.bump.outputs.new_version }}"
          fi
          echo "tag=$VERSION_TAG" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check Test Results
        run: |
          echo "=== Test Results Summary ==="
          echo "Security Scan: ${{ needs.security-scan.result }}"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Type Check: ${{ needs.type-check.result }}"
          echo "Dockerfile Lint: ${{ needs.dockerfile-lint.result }}"
          echo "Push on failure: ${{ inputs.push_on_test_failure }}"
          
          if [ "${{ inputs.push_on_test_failure }}" = "yes" ]; then
            echo "⚠️ Building image despite test failures (push_on_test_failure=yes)"
          else
            echo "✅ All tests passed, proceeding with build"
          fi

      - name: Build Docker Image
        working-directory: NodeJsapp
        run: |
          VERSION_TAG="${{ steps.version.outputs.tag }}"
          FULL_IMAGE_NAME="${{ steps.version.outputs.full_image_name }}"
          IMAGE_URI=$FULL_IMAGE_NAME:$VERSION_TAG
          
          echo "=== Building Docker Image ==="
          docker build -t $IMAGE_URI .
          docker tag $IMAGE_URI $FULL_IMAGE_NAME:latest
          echo "✅ Docker image built: $IMAGE_URI"

      - name: Save Docker Image
        run: |
          VERSION_TAG="${{ steps.version.outputs.tag }}"
          FULL_IMAGE_NAME="${{ steps.version.outputs.full_image_name }}"
          
          echo "=== Saving Docker Image ==="
          docker save $FULL_IMAGE_NAME:$VERSION_TAG | gzip > /tmp/docker-image.tar.gz
          echo "✅ Image saved"

      - name: Upload Docker Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/docker-image.tar.gz
          retention-days: 1

  test-image-health:
    name: Test Image Health
    runs-on: ubuntu-latest
    needs: [build-image]
    if: ${{ always() && needs.build-image.result == 'success' }}
    continue-on-error: ${{ inputs.push_on_test_failure == 'yes' }}
    
    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker Image
        run: |
          echo "=== Loading Docker Image ==="
          docker load < /tmp/docker-image.tar.gz
          echo "✅ Image loaded"

      - name: Test Health Endpoint
        run: |
          IMAGE_URI="${{ needs.build-image.outputs.image_name }}:${{ needs.build-image.outputs.image_tag }}"
          
          echo "=== Testing Health Endpoint ==="
          docker run -d --name health-test \
            -p 3000:3000 \
            -e DBUSER=testuser \
            -e DB=testdb \
            -e DBPASS=testpass \
            -e DBHOST=localhost \
            -e DBPORT=3306 \
            $IMAGE_URI
          
          sleep 5
          
          echo "Testing /health endpoint..."
          if curl -f http://localhost:3000/health; then
            echo "✅ Health check passed"
          else
            echo "❌ Health check failed"
            docker logs health-test
            exit 1
          fi
          
          docker stop health-test
          docker rm health-test

  test-image-startup:
    name: Test Image Startup
    runs-on: ubuntu-latest
    needs: [build-image]
    if: ${{ always() && needs.build-image.result == 'success' }}
    continue-on-error: ${{ inputs.push_on_test_failure == 'yes' }}
    
    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker Image
        run: |
          echo "=== Loading Docker Image ==="
          docker load < /tmp/docker-image.tar.gz
          echo "✅ Image loaded"

      - name: Test Container Startup
        run: |
          IMAGE_URI="${{ needs.build-image.outputs.image_name }}:${{ needs.build-image.outputs.image_tag }}"
          
          echo "=== Testing Container Startup ==="
          docker run -d --name startup-test \
            -p 3001:3000 \
            -e DBUSER=testuser \
            -e DB=testdb \
            -e DBPASS=testpass \
            -e DBHOST=localhost \
            -e DBPORT=3306 \
            $IMAGE_URI
          
          sleep 5
          
          if docker ps | grep startup-test; then
            echo "✅ Container started successfully"
          else
            echo "❌ Container failed to start"
            docker logs startup-test
            exit 1
          fi
          
          docker stop startup-test
          docker rm startup-test

  test-image-size:
    name: Test Image Size
    runs-on: ubuntu-latest
    needs: [build-image]
    if: ${{ always() && needs.build-image.result == 'success' }}
    continue-on-error: ${{ inputs.push_on_test_failure == 'yes' }}
    
    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker Image
        run: |
          echo "=== Loading Docker Image ==="
          docker load < /tmp/docker-image.tar.gz
          echo "✅ Image loaded"

      - name: Check Image Size
        run: |
          IMAGE_URI="${{ needs.build-image.outputs.image_name }}:${{ needs.build-image.outputs.image_tag }}"
          
          echo "=== Checking Image Size ==="
          IMAGE_SIZE=$(docker image inspect $IMAGE_URI --format='{{.Size}}')
          IMAGE_SIZE_MB=$((IMAGE_SIZE / 1024 / 1024))
          
          echo "Image size: ${IMAGE_SIZE_MB}MB"
          
          if [ $IMAGE_SIZE_MB -gt 500 ]; then
            echo "⚠️ Image is larger than 500MB"
          else
            echo "✅ Image size is acceptable"
          fi

  push-image:
    name: Push Docker Image
    runs-on: ubuntu-latest
    needs: [build-image, test-image-health, test-image-startup, test-image-size]
    if: ${{ always() && needs.build-image.result == 'success' && (inputs.push_on_test_failure == 'yes' || (needs.test-image-health.result == 'success' && needs.test-image-startup.result == 'success' && needs.test-image-size.result == 'success')) }}
    environment: dev
    
    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker Image
        run: |
          echo "=== Loading Docker Image ==="
          docker load < /tmp/docker-image.tar.gz
          echo "✅ Image loaded"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Check Image Test Results
        run: |
          echo "=== Image Test Results Summary ==="
          echo "Health Test: ${{ needs.test-image-health.result }}"
          echo "Startup Test: ${{ needs.test-image-startup.result }}"
          echo "Size Test: ${{ needs.test-image-size.result }}"
          echo "Push on failure: ${{ inputs.push_on_test_failure }}"
          
          if [ "${{ inputs.push_on_test_failure }}" = "yes" ]; then
            echo "⚠️ Pushing image despite test failures (push_on_test_failure=yes)"
          else
            echo "✅ All image tests passed, proceeding with push"
          fi

      - name: Push Docker Image to Docker Hub
        run: |
          VERSION_TAG="${{ needs.build-image.outputs.image_tag }}"
          FULL_IMAGE_NAME="${{ needs.build-image.outputs.image_name }}"
          
          echo "=== Pushing Docker Image ==="
          docker push $FULL_IMAGE_NAME:$VERSION_TAG
          echo "✅ Pushed: $FULL_IMAGE_NAME:$VERSION_TAG"
          
          if [ "${{ inputs.version_bump }}" != "none" ]; then
            docker push $FULL_IMAGE_NAME:latest
            echo "✅ Pushed: $FULL_IMAGE_NAME:latest"
          fi
