name: Build and Push Docker Image to Docker Hub

on:
  workflow_dispatch:
    inputs:
      dockerhub_username:
        description: "Docker Hub username (e.g., liken01else)"
        required: true
        type: string
        default: "liken01else"
      image_name:
        description: "Image name (e.g., api, web, myapp)"
        required: true
        type: string
        default: "api"
      version_bump:
        description: "Version bump type (major, minor, patch) or 'none' for latest only"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - none
        default: "patch"
        
env:
  DOCKERFILE_PATH: '.'

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      contents: write
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest version from Docker Hub
        id: get-version
        if: inputs.version_bump != 'none'
        run: |
          FULL_IMAGE_NAME="${{ inputs.dockerhub_username }}/${{ inputs.image_name }}"
          TAGS=$(curl -s "https://hub.docker.com/v2/repositories/$FULL_IMAGE_NAME/tags/?page_size=100" | jq -r '.results[].name' | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sed 's/^v//' | sort -V | tail -1)
          
          if [ -z "$TAGS" ]; then
            LATEST_VERSION="0.0.0"
          else
            LATEST_VERSION="$TAGS"
          fi
          
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: Bump version
        id: bump
        if: inputs.version_bump != 'none'
        run: |
          LATEST_VERSION="${{ steps.get-version.outputs.latest_version }}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST_VERSION"
          
          case "${{ inputs.version_bump }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Set version tag and full image name
        id: version
        run: |
          FULL_IMAGE_NAME="${{ inputs.dockerhub_username }}/${{ inputs.image_name }}"
          echo "full_image_name=$FULL_IMAGE_NAME" >> $GITHUB_OUTPUT
          
          if [ "${{ inputs.version_bump }}" = "none" ]; then
            VERSION_TAG="latest"
          else
            VERSION_TAG="${{ steps.bump.outputs.new_version }}"
          fi
          echo "tag=$VERSION_TAG" >> $GITHUB_OUTPUT

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        working-directory: ${{ env.DOCKERFILE_PATH }}
        run: |
          VERSION_TAG="${{ steps.version.outputs.tag }}"
          FULL_IMAGE_NAME="${{ steps.version.outputs.full_image_name }}"
          IMAGE_URI=$FULL_IMAGE_NAME:$VERSION_TAG
          
          docker build -t $IMAGE_URI .
          docker tag $IMAGE_URI $FULL_IMAGE_NAME:latest

      - name: Push Docker Image to Docker Hub
        run: |
          VERSION_TAG="${{ steps.version.outputs.tag }}"
          FULL_IMAGE_NAME="${{ steps.version.outputs.full_image_name }}"
          
          docker push $FULL_IMAGE_NAME:$VERSION_TAG
          
          if [ "${{ inputs.version_bump }}" != "none" ]; then
            docker push $FULL_IMAGE_NAME:latest
          fi
